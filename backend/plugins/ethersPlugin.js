import fp from "fastify-plugin";
import { listenToEvents } from "../contract/services/Eventlistener.js";
import { Contract, WebSocketProvider } from "ethers";
import { JsonRpcProvider } from "ethers";
import { MarketplaceContractConfig } from "../contract/marketPlace.js";
import MailService from "../services/mailService.js";

const ethersPlugin = fp(async function (fastify, opts) {
    try {
        let provider;
        if (opts.rpcUrl.startsWith("ws")) {
            provider = new WebSocketProvider(opts.rpcUrl);
        } else {
            provider = new JsonRpcProvider(opts.rpcUrl);
        }
    
        // Verify connection
        await provider.getBlockNumber();
    
        const contract = new Contract(
            ...MarketplaceContractConfig,
            provider
        );
    
        fastify.decorate("ethers", { provider, contract });
    
        fastify.decorate("mailservice", (new MailService(fastify.mailer, "RowMart")));
    
        listenToEvents(fastify);
    
        fastify.log.info("Ethers provider connected");
    
        fastify.addHook("onClose", async () => {
            if (provider.destroy) {
                provider.destroy();
            }
        });
    } catch(err) {
        fastify.close();
    }
});

export default ethersPlugin;